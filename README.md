# Last-mile-drone-delivery-problem

## Overview

This project implements and compares two approaches for solving the multi-depot drone routing problem inspired by Zipline's drone delivery system. The project aims to maximize the number of orders delivered within a time frame while minimizing delivery times, considering order priorities, battery constraints, and multi-depot operations.

---

## Problem Description

The system manages:

- **Multiple depots** where drones are stored and recharged
- **Dynamic order arrivals** with pickup and delivery locations
- **Order priorities** (Low, Medium, High, Emergency) as requested by customers
- **Battery constraints** and cross-depot optimization
- **Real-time assignment decisions** under time constraints

---

## Approaches Implemented

1. **Greedy Approach**  
   A baseline heuristic algorithm with data collection capabilities.
2. **GNN-ALNS Approach**  
   A machine learning enhanced system using Graph Neural Networks (GNN) with Adaptive Large Neighborhood Search (ALNS).

---

## Project Structure

```
├── greedy_approach.py          # Baseline greedy algorithm with visualization and data collection
├── GNN_ALNS.py                 # GNN-enhanced HAD (Hierarchical Anytime Dispatcher) algorithm
├── greedy_training_data.pkl    # Training data generated by greedy approach (created after running)
├── best_gnn_model.pth          # Trained GNN model (created after training)
└── README.md                   # This file
```

---

## Required Packages

Install dependencies:

```bash
pip install numpy matplotlib torch torchvision scikit-learn pickle-mixin
```

**Package Requirements:**

- numpy — Numerical computations
- matplotlib — Visualization and animation
- torch — PyTorch for neural networks
- scikit-learn — Data preprocessing and scaling
- pickle — Data serialization
- dataclasses — Data structure definitions
- typing — Type hints
- threading — Background optimization
- collections — Data structures
- heapq — Priority queues
- enum — Enumerations
- json — Data serialization
- datetime — Time handling
- random — Random number generation
- time — Timing operations

---

## How to Run

### 1. Greedy Approach (Data Collection Phase)

**Basic Usage:**

```bash
python greedy_approach.py
```

**Description:**

The greedy approach script implements a baseline heuristic algorithm that:

- Uses a priority-based greedy assignment strategy
- Optimizes cross-depot operations for better load balancing
- Provides enhanced real-time visualization with route animations
- Collects training data for the GNN model

**Configuration:**

Modify parameters in the `if __name__ == "__main__":` section:

- `region`: `'texas'`, `'arkansas'`, `'north_carolina'`, `'utah'`
- `size`: `'small'`, `'medium'`, `'large'`
- `duration`: Simulation time (default: `350.0`)
- `dt`: Time step (default: `1.0`)
- `order_rate`: Order arrival rate (default: `0.9`)

**Outputs:**

- **Console Output:**  
  Instance information, real-time metrics, performance statistics
- **Visual Output:**  
  - Depot locations (squares)
  - Drone movements (triangles)
  - Pickup (P) and delivery (D) locations
  - Route planning with arrows
  - Priority-coded connections
- **Generated Files:**  
  `greedy_training_data.pkl`: Training data with state-action pairs

---

### 2. GNN-ALNS Approach (Training and Optimization Phase)

**Usage Modes:**

- Full pipeline (recommended):

  ```bash
  python GNN_ALNS.py
  ```

- Training only:

  ```bash
  python GNN_ALNS.py train
  ```

- Simulation only (with pre-trained model):

  ```bash
  python GNN_ALNS.py simulate
  ```

**Description:**

The GNN-ALNS approach implements a two-layer system:

- **Layer 1 (Lightning Assignment):** Fast GNN-based assignments
- **Layer 2 (Rolling Horizon ALNS):** Background optimization (TODO)
- **HAD:** Combines both layers for optimal performance (TODO)

**Arguments:**

- `train`: Train the GNN model
- `simulate`: Run simulation with trained model
- `pipeline`: Train + simulate (default)

**Outputs:**

- **Training Phase:**
  ```
  Loaded training data: X samples
  Epoch 0/50, Train Loss: X.XXXX, Val Loss: X.XXXX
  ...
  Training completed!
  Trained model saved as 'trained_gnn_model.pth'
  ```
- **Simulation Phase:**
  - Real-time metrics, GNN-specific statistics
  - Enhanced visualization (labelled "Trained HAD-GNN")
  - Performance plots:
    - Completed orders over time
    - Average delivery times
    - Lightning assignments vs ALNS optimizations
- **Generated Files:**
  - `best_gnn_model.pth`
  - `trained_gnn_model.pth`

---

## Relationship Between Approaches

**Data Flow:**

```
Greedy Approach → Collects training data → greedy_training_data.pkl
GNN-ALNS Approach → Loads data → Trains GNN → Enhanced routing
```

**Training Data:**

- **State Features:** Order details, drone status, depot info, system state
- **Action Features:** Drone/depot assignments
- **Rewards:** Priority-based scoring

**GNN Architecture:**

- **Input:** 14-dimensional feature vectors
- **Model:** Graph Attention Network (3 layers)
- **Output:** Feasibility scores, value predictions
- **Training:** Supervised learning on greedy decisions

---

## Expected Performance

**Greedy Approach:**

- Baseline heuristic decisions
- Generates 50–200+ samples
- Interpretable assignment logic

**GNN-ALNS Approach:**

- Improved assignment quality
- Faster routine decisions
- Enhanced performance on complex scenarios

---

## File Dependencies

**Run Order:**

1. Run `greedy_approach.py` to generate training data
2. Run `GNN_ALNS.py` to train/test the GNN system

**Data Persistence:**

- Training data and models persist between runs
- Simulation parameters adjustable independently

---


**Performance Tuning:**

- Adjust `dt` for animation speed
- Change `order_rate` for scenario difficulty
- Modify training epochs and batch size
- Tune GNN architecture in `BipartiteMatchingGAT`
